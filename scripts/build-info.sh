#!/bin/bash

# THDN-PrintServer 构建信息生成脚本
# 生成固件构建信息和版本说明

set -e

BUILD_DATE=$(date +"%Y-%m-%d %H:%M:%S")
BUILD_VERSION=$(date +"%Y%m%d")
GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
OPENWRT_VERSION="17.01.7"
TARGET_PLATFORM="ar71xx/generic"
CUPS_VERSION="2.4.x"
HPLIP_VERSION="3.23.x"

OUTPUT_DIR="output"
INFO_FILE="${OUTPUT_DIR}/firmware-info.txt"

# 创建输出目录
mkdir -p "${OUTPUT_DIR}"

# 生成构建信息
cat > "${INFO_FILE}" << EOF
================================================================================
THDN-PrintServer OpenWrt17 固件构建信息
================================================================================

构建时间: ${BUILD_DATE}
构建版本: ${BUILD_VERSION}
Git提交: ${GIT_COMMIT}
OpenWrt版本: ${OPENWRT_VERSION}
目标平台: ${TARGET_PLATFORM}

================================================================================
软件版本信息
================================================================================

CUPS版本: ${CUPS_VERSION}
HPLIP版本: ${HPLIP_VERSION}
内核版本: Linux 4.4.x

================================================================================
功能特性
================================================================================

✅ CUPS 中文打印服务
✅ HP LaserJet 1020/1020plus 驱动支持
✅ USB 打印机自动检测
✅ 定时重启功能（每日凌晨4:00）
✅ 中文 Web 管理界面
✅ 优化的网络配置

================================================================================
默认配置信息
================================================================================

LAN IP地址: 192.168.10.1
Web管理账号: admin
Web管理密码: thdn12345678
Wi-Fi SSID: THDN-dayin
Wi-Fi密码: thdn12345678
主机名: THDN-PrintServer

================================================================================
固件文件说明
================================================================================

sysupgrade.bin - 系统升级固件，用于已刷OpenWrt的设备升级
factory.bin - 工厂固件，用于从原厂固件刷入OpenWrt

================================================================================
使用说明
================================================================================

1. 固件刷入：
   - 通过Web界面：登录原厂路由器管理界面，选择固件升级
   - 通过TFTP：使用TFTP工具刷入factory.bin

2. 首次配置：
   - 刷入后访问 http://192.168.10.1
   - 使用 admin/thdn12345678 登录
   - 连接USB打印机到路由器

3. 打印服务管理：
   - 访问 http://192.168.10.1:631 管理打印机
   - 或在Luci界面中点击"服务"->"CUPS打印服务"

================================================================================
注意事项
================================================================================

⚠️ 刷机有风险，请谨慎操作
⚠️ 请确保路由器有至少16MB Flash存储空间
⚠️ 建议先备份原厂固件
⚠️ 刷机过程中请勿断电
⚠️ 如遇到问题，请查看系统日志

================================================================================
技术支持
================================================================================

项目地址: https://github.com/your-repo/thdn-printserver
构建脚本: build.sh
配置文件: configs/thdn-config

================================================================================
构建环境信息
================================================================================

构建系统: Ubuntu 22.04 LTS
内核架构: ar71xx/generic
Flash要求: 16MB+
RAM要求: 64MB+

================================================================================

EOF

echo "构建信息已生成: ${INFO_FILE}"

# 如果存在固件文件，列出文件信息
if [ -d "openwrt/bin/targets/ar71xx/generic/" ]; then
    echo "" >> "${INFO_FILE}"
    echo "================================================================================" >> "${INFO_FILE}"
    echo "生成的固件文件" >> "${INFO_FILE}"
    echo "================================================================================" >> "${INFO_FILE}"
    
    for file in openwrt/bin/targets/ar71xx/generic/*.bin; do
        if [ -f "$file" ]; then
            filename=$(basename "$file")
            filesize=$(ls -lh "$file" | awk '{print $5}')
            filedate=$(date -r "$file" +"%Y-%m-%d %H:%M:%S")
            echo "文件: ${filename}" >> "${INFO_FILE}"
            echo "大小: ${filesize}" >> "${INFO_FILE}"
            echo "时间: ${filedate}" >> "${INFO_FILE}"
            echo "" >> "${INFO_FILE}"
            
            # 复制到输出目录
            cp "$file" "${OUTPUT_DIR}/"
        fi
    done
fi

echo "固件信息文件生成完成: ${INFO_FILE}"
